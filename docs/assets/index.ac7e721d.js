const F=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))t(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&t(c)}).observe(document,{childList:!0,subtree:!0});function a(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerpolicy&&(s.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?s.credentials="include":i.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function t(i){if(i.ep)return;i.ep=!0;const s=a(i);fetch(i.href,s)}};F();const C=1e3,p=30,M=42,_=240,m=60,V=1e3,E=10,b=5,T=.01,A=10;class R{constructor(e,a,t,i,s,c){this.webcamId=e,this.canvasId=a,this.classifierPath=t,this.streaming=!1,this.faceValid=!1,this.targetFps=i,this.windowSize=s,this.rppgInterval=c}async startStreaming(){try{this.stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user",width:{exact:this.webcamVideoElement.width},height:{exact:this.webcamVideoElement.height}},audio:!1})}catch(e){console.log(e)}if(!this.stream)throw new Error("Could not obtain video from webcam.");return this.webcamVideoElement.srcObject=this.stream,this.webcamVideoElement.play(),this.streaming=!0,new Promise(e=>{this.webcamVideoElement.oncanplay=()=>{e()}})}async createFileFromUrl(e,a){let t=new XMLHttpRequest;return t.open("GET",a,!0),t.responseType="arraybuffer",t.send(),new Promise(i=>{t.onload=()=>{if(t.readyState===4)if(t.status===200){let s=new Uint8Array(t.response);cv.FS_createDataFile("/",e,s,!0,!1,!1),i()}else console.log("Failed to load "+a+" status: "+t.status)}})}async init(){this.webcamVideoElement=document.getElementById(this.webcamId);try{await this.startStreaming(),this.webcamVideoElement.width=this.webcamVideoElement.videoWidth,this.webcamVideoElement.height=this.webcamVideoElement.videoHeight,this.frameRGB=new cv.Mat(this.webcamVideoElement.height,this.webcamVideoElement.width,cv.CV_8UC4),this.lastFrameGray=new cv.Mat(this.webcamVideoElement.height,this.webcamVideoElement.width,cv.CV_8UC1),this.frameGray=new cv.Mat(this.webcamVideoElement.height,this.webcamVideoElement.width,cv.CV_8UC1),this.overlayMask=new cv.Mat(this.webcamVideoElement.height,this.webcamVideoElement.width,cv.CV_8UC1),this.cap=new cv.VideoCapture(this.webcamVideoElement),this.signal=[],this.timestamps=[],this.rescan=[],this.face=new cv.Rect,this.classifier=new cv.CascadeClassifier;let e="haarcascade_frontalface_alt.xml";this.classifier.load(e)||(await this.createFileFromUrl(e,this.classifierPath),this.classifier.load(e)),this.scanTimer=setInterval(this.processFrame.bind(this),V/this.targetFps),this.rppgTimer=setInterval(this.rppg.bind(this),this.rppgInterval)}catch(e){console.log(e)}}processFrame(){try{this.frameGray.empty()||this.frameGray.copyTo(this.lastFrameGray),this.cap.read(this.frameRGB);let e=Date.now(),a=!1;if(cv.cvtColor(this.frameRGB,this.frameGray,cv.COLOR_RGBA2GRAY),this.faceValid?e-this.lastScanTime>=C&&(this.lastScanTime=e,this.detectFace(this.frameGray),a=!0):(this.lastScanTime=e,this.detectFace(this.frameGray)),this.faceValid){for(;this.signal.length>this.targetFps*this.windowSize;)this.signal.shift(),this.timestamps.shift(),this.rescan.shift();let t=new cv.Mat;t=this.makeMask(this.frameGray,this.face);let i=cv.mean(this.frameRGB,t);t.delete(),this.signal.push(i.slice(0,3)),this.timestamps.push(e),this.rescan.push(a)}cv.rectangle(this.frameRGB,new cv.Point(this.face.x,this.face.y),new cv.Point(this.face.x+this.face.width,this.face.y+this.face.height),[0,255,0,255]),this.frameRGB.setTo([255,0,0,255],this.overlayMask),cv.imshow(this.canvasId,this.frameRGB)}catch(e){console.log("Error capturing frame:"),console.log(e)}}detectFace(e){let a=new cv.RectVector;this.classifier.detectMultiScale(e,a,1.1,3,0),a.size()>0?(this.face=a.get(0),this.faceValid=!0):(console.log("No faces"),this.invalidateFace()),a.delete()}makeMask(e,a){let t=cv.Mat.zeros(e.rows,e.cols,cv.CV_8UC1),i=new cv.Scalar(255,255,255,255),s=new cv.Point(Math.round(a.x+.3*a.width),Math.round(a.y+.1*a.height)),c=new cv.Point(Math.round(a.x+.7*a.width),Math.round(a.y+.25*a.height));return cv.rectangle(t,s,c,i,-1),t}invalidateFace(){this.signal=[],this.timestamps=[],this.rescan=[],this.overlayMask.setTo([0,0,0,0]),this.face=new cv.Rect,this.faceValid=!1,this.corners=[]}trackFace(e,a){let t=cv.Mat.zeros(a.rows,a.cols,cv.CV_8UC1),i=new Uint8Array([this.face.x+.22*this.face.width,this.face.y+.21*this.face.height,this.face.x+.78*this.face.width,this.face.y+.21*this.face.height,this.face.x+.7*this.face.width,this.face.y+.65*this.face.height,this.face.x+.3*this.face.width,this.face.y+.65*this.face.height]),s=cv.matFromArray(4,1,cv.CV_32SC2,i),c=new cv.MatVector,o=new cv.Mat;c.push_back(s),cv.fillPoly(t,c,[255,255,255,255]),cv.goodFeaturesToTrack(e,o,E,T,A,t,3),t.delete(),s.delete(),c.delete();let r=new cv.Mat,l=new cv.Mat,d=new cv.Mat,w=new cv.Size(15,15),f=2,y=new cv.TermCriteria(cv.TERM_CRITERIA_EPS|cv.TERM_CRITERIA_COUNT,10,.03);cv.calcOpticalFlowPyrLK(e,a,o,r,l,d,w,f,y);let v=new cv.Mat;if(cv.calcOpticalFlowPyrLK(a,e,r,v,l,d,w,f,y),l.delete(),d.delete(),r.rows>=b){const[n,u,g]=this.estimateAffineTransform(v,r);this.face=new cv.Rect(this.face.x*n+u,this.face.y*n+g,this.face.width*n,this.face.height*n)}else this.invalidateFace();o.delete(),r.delete(),v.delete()}estimateAffineTransform(e,a){let t=cv.matFromArray(e.rows*2,1,cv.CV_32FC1,Array.from(e.data32F)),i=cv.matFromArray(a.rows*2,1,cv.CV_32FC1,Array.from(a.data32F)),s=new cv.Mat(e.rows*2,3,cv.CV_32FC1),c=new cv.Mat,o=new cv.Mat;cv.repeat(cv.matFromArray(2,1,cv.CV_32FC1,[1,0]),e.rows,1,c),cv.repeat(cv.matFromArray(2,1,cv.CV_32FC1,[0,1]),e.rows,1,o),t.copyTo(s.col(0)),c.copyTo(s.col(1)),o.copyTo(s.col(2));let r=cv.Mat.zeros(3,1,cv.CV_32FC1);return cv.solve(s,i,r,cv.DECOMP_SVD),o.delete(),c.delete(),s.delete(),t.delete(),i.delete(),[r.data32F[0],r.data32F[1],r.data32F[2]]}rppg(){let e=this.getFps(this.timestamps);if(this.signal.length>=this.targetFps*this.windowSize){let a=cv.matFromArray(this.signal.length,1,cv.CV_32FC3,[].concat.apply([],this.signal));this.denoise(a,this.rescan),this.standardize(a),this.detrend(a,e),this.movingAverage(a,3,Math.max(Math.floor(e/6),2)),a=this.selectGreen(a),this.overlayMask.setTo([0,0,0,0]),this.drawTime(a),this.timeToFrequency(a,!0);let t=Math.floor(a.rows*M/m/e),i=Math.ceil(a.rows*_/m/e);if(!a.empty()){let s=cv.matFromArray(a.rows,1,cv.CV_8U,new Array(a.rows).fill(0).fill(1,t,i+1));this.drawFrequency(a,t,i,s);let c=cv.minMaxLoc(a,s);s.delete();let o=c.maxLoc.y*e/a.rows*m;document.getElementById("information").innerText=`Your Heart Rate: ${o.toFixed(1)} Bpm`,this.drawBPM(o)}a.delete()}else document.getElementById("information").innerHTML="Estimating..."}getFps(e,a=1e3){if(Array.isArray(e)&&e.length){if(e.length==1)return p;{let t=e[e.length-1]-e[0];return e.length/t*a}}else return p}denoise(e,a){let t=new cv.Mat;cv.subtract(e.rowRange(1,e.rows),e.rowRange(0,e.rows-1),t);for(var i=1;i<e.rows;i++)if(a[i]==!0){let s=new cv.MatVector,c=cv.matFromArray(e.rows,1,cv.CV_32FC1,new Array(e.rows).fill(0).fill(t.data32F[(i-1)*3],i,e.rows)),o=cv.matFromArray(e.rows,1,cv.CV_32FC1,new Array(e.rows).fill(0).fill(t.data32F[(i-1)*3+1],i,e.rows)),r=cv.matFromArray(e.rows,1,cv.CV_32FC1,new Array(e.rows).fill(0).fill(t.data32F[(i-1)*3+2],i,e.rows));s.push_back(c),s.push_back(o),s.push_back(r);let l=new cv.Mat;cv.merge(s,l),cv.subtract(e,l,e),s.delete(),c.delete(),o.delete(),r.delete(),l.delete()}t.delete()}standardize(e){let a=new cv.Mat,t=new cv.Mat,i=new cv.Mat;cv.meanStdDev(e,a,t,i);let s=cv.matFromArray(1,1,cv.CV_32FC3,[a.data64F[0],a.data64F[1],a.data64F[2]]),c=cv.matFromArray(1,1,cv.CV_32FC3,[t.data64F[0],t.data64F[1],t.data64F[2]]),o=new cv.Mat(e.rows,1,cv.CV_32FC3),r=new cv.Mat(e.rows,1,cv.CV_32FC3);cv.repeat(s,e.rows,1,o),cv.repeat(c,e.rows,1,r),cv.subtract(e,o,e,i,-1),cv.divide(e,r,e,1,-1),a.delete(),t.delete(),i.delete(),s.delete(),c.delete(),o.delete(),r.delete()}detrend(e,a){let t=cv.Mat.zeros(e.rows-2,e.rows,cv.CV_32FC1),i=cv.Mat.eye(e.rows,e.rows,cv.CV_32FC1),s=cv.Mat.ones(e.rows-2,1,cv.CV_32FC1),c=cv.matFromArray(e.rows-2,1,cv.CV_32FC1,new Array(e.rows-2).fill(-2)),o=new cv.Mat;s.copyTo(t.diag(0)),c.copyTo(t.diag(1)),s.copyTo(t.diag(2)),cv.gemm(t,t,a*a,o,0,t,cv.GEMM_1_T),cv.add(i,t,t,o,-1),cv.invert(t,t,cv.DECOMP_LU),cv.subtract(i,t,t,o,-1);let r=new cv.MatVector;cv.split(e,r),cv.gemm(t,r.get(0),1,o,0,r.get(0),0),cv.gemm(t,r.get(1),1,o,0,r.get(1),0),cv.gemm(t,r.get(2),1,o,0,r.get(2),0),cv.merge(r,e),t.delete(),i.delete(),s.delete(),c.delete(),o.delete(),r.delete()}movingAverage(e,a,t){for(var i=0;i<a;i++)cv.blur(e,e,{height:t,width:1})}selectGreen(e){let a=new cv.MatVector;cv.split(e,a);let t=a.get(1);return a.delete(),t}timeToFrequency(e,a){let t=new cv.MatVector;t.push_back(e),t.push_back(new cv.Mat.zeros(e.rows,1,cv.CV_32F)),new cv.Mat,cv.merge(t,e),cv.dft(e,e,cv.DFT_COMPLEX_OUTPUT),a&&(cv.split(e,t),cv.magnitude(t.get(0),t.get(1),e))}drawTime(e){}drawFrequency(e,a,t,i){}drawCorners(e){for(var a=0;a<e.rows;a++)cv.circle(this.frameRGB,new cv.Point(e.data32F[a*2],e.data32F[a*2+1]),5,[0,255,0,255],-1)}drawBPM(e){cv.putText(this.overlayMask,e.toFixed(0).toString(),new cv.Point(this.face.x,this.face.y-10),cv.FONT_HERSHEY_PLAIN,1.5,[255,0,0,255],2)}stop(){clearInterval(this.rppgTimer),clearInterval(this.scanTimer),this.webcam&&(this.webcamVideoElement.pause(),this.webcamVideoElement.srcObject=null),this.stream&&this.stream.getVideoTracks()[0].stop(),this.invalidateFace(),this.streaming=!1,this.frameRGB.delete(),this.lastFrameGray.delete(),this.frameGray.delete(),this.overlayMask.delete()}}const x="opencv.js",P="haarcascade_frontalface_alt.xml";async function S(h){return new Promise(function(e,a){console.log("starting to load opencv");var t=document.createElement("script");t.src=h,t.async=!0,t.type="text/javascript",t.onload=()=>{cv.onRuntimeInitialized=()=>{console.log("opencv ready"),e()}},t.onerror=()=>{throw new URIError("opencv didn't load correctly.")};var i=document.getElementsByTagName("script")[0];i.parentNode.insertBefore(t,i)})}let I=new R("webcam","canvas",P,30,6,250);var k=S(x);k.then(function(){I.init()});
